### **Определение Prometheus TSDB (Time Series Database)**

**Prometheus TSDB (Time Series Database)** — это высокоэффективная база данных временных рядов, разработанная специально для системы мониторинга Prometheus. Она предназначена для хранения и управления большими объемами метрик в формате временных рядов, где каждая точка данных связана с меткой времени. TSDB обеспечивает быстрый доступ к историческим данным, эффективное использование дискового пространства и поддержку высокой производительности при записи и чтении.

---

### **Структура и составляющие Prometheus TSDB**

1. **Временные ряды (Time Series):**
   - Каждый временной ряд представляет собой последовательность пар "лейбл времени — значение", уникально идентифицируемую комбинацией имени метрики и набора лейблов (меток).
   - Например, временной ряд `http_requests_total{method="GET", handler="/api"}` содержит значения числа HTTP-запросов методом GET для обработчика `/api` во времени.

2. **Блоки данных (Blocks):**
   - Данные в TSDB организованы в блоки, каждый из которых содержит метрики за определенный период времени (обычно 2 часа).
   - Блоки состоят из нескольких файлов:
     - **Chunk Files**: Содержат сжатые данные временных рядов.
     - **Index Files**: Хранят индексы для быстрого поиска временных рядов.
     - **WAL (Write-Ahead Log)**: Журнал операций записи, обеспечивающий отказоустойчивость.

3. **Метаданные:**
   - Включают информацию о временных рядах, таких как имена метрик, метки и их значения.
   - Метаданные используются для эффективного поиска и фильтрации данных.

4. **Компрессия данных:**
   - Для минимизации использования дискового пространства применяются алгоритмы сжатия данных и индексов.

---

### **Процесс формирования и работы TSDB**

#### 1. **Запись данных:**
   - Prometheus собирает метрики с целевых систем через механизм скрейпинга (scraping), отправляя HTTP-запросы к экспортерам или другим источникам данных.
   - Полученные метрики преобразуются во временные ряды и записываются в TSDB.
   - Перед записью данные временно хранятся в **Write-Ahead Log (WAL)** для обеспечения надежности. Если происходит сбой, WAL позволяет восстановить недозаписанные данные.

#### 2. **Организация данных в блоках:**
   - По мере накопления данных они группируются в блоки, каждый из которых охватывает конкретный временной интервал (например, 2 часа).
   - После создания блока он становится неизменяемым (immutable), что упрощает его обслуживание и оптимизацию.

#### 3. **Компактификация (compaction):**
   - Со временем накапливается множество маленьких блоков. Чтобы оптимизировать использование дискового пространства и повысить производительность, Prometheus выполняет процесс компактификации (compaction).
   - Компактификация объединяет несколько маленьких блоков в более крупные, удаляя дублирующиеся данные и применяя дополнительное сжатие.

#### 4. **Удаление старых данных:**
   - Prometheus поддерживает политику хранения данных (retention policy). По истечении заданного периода (например, 15 дней) старые блоки автоматически удаляются из TSDB.

---

### **Алгоритмы и механизмы работы TSDB**

1. **Сжатие данных:**
   - Prometheus использует специализированные алгоритмы сжатия для минимизации размера хранимых данных. Например, временные метки (лейблы) сжимаются с помощью дельта-кодирования, а значения метрик — с использованием Gorilla compression.

2. **Индексирование:**
   - Индексы позволяют быстро находить нужные временные ряды на основе имени метрики и лейблов.
   - Индекс хранится в отдельных файлах внутри каждого блока.

3. **Чтение данных:**
   - При выполнении запроса PromQL TSDB ищет соответствующие временные ряды в индексах, затем читает их значения из chunk files.
   - Для запросов с агрегацией или вычислениями TSDB предоставляет только необходимые данные, минимизируя объем считываемой информации.

---

### **Описание процесса записи**

1. **Получение метрик:**
   - Prometheus регулярно запрашивает метрики у целевых систем (таргетов) и получает их в формате временных рядов.

2. **Обработка данных:**
   - Метрики проверяются на корректность, преобразуются в структуру временных рядов и добавляются в память.

3. **Запись в WAL:**
   - Перед записью в основную базу данных метрики сохраняются в Write-Ahead Log для обеспечения отказоустойчивости.

4. **Перенос в TSDB:**
   - Данные из WAL периодически переносятся в основную базу данных и организуются в блоки.

5. **Формирование блоков:**
   - Когда объем данных достигает определенного порога или проходит заданный временной интервал, создается новый блок.

6. **Компактификация и очистка:**
   - Блоки компактифицируются для оптимизации, а старые данные удаляются согласно политике хранения.

---

### **Значение Prometheus TSDB**

Prometheus TSDB является центральным компонентом системы мониторинга Prometheus, обеспечивающим:
- Эффективное хранение и управление большими объемами метрик.
- Высокую производительность при записи и чтении данных.
- Поддержку сложных аналитических запросов через язык PromQL.
- Отказоустойчивость и масштабируемость для работы в распределенных системах.

TSDB играет основную роль в обеспечении функциональности Prometheus, делая его одним из самых популярных решений для мониторинга современных IT-систем.
