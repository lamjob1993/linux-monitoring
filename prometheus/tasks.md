# Prometheus

## Backend

### Внимание!

_Вспоминаем тему по форку репозитория и после выполнения этого раздела обязательно пушим Unit-файл к себе в клон, а также конфиг-файл. То есть на этом этапе у вас должно прийти понимание зачем нужен `Git` + `GitHub` (то есть если ваш конфиг сломает коллега на работе, то `Git` или `GitHub` позволит откатить изменения до рабочего значения - это одно из применений системы контроля версий)._

_Для выполенния всех заданий в репозитории пользуемся официальной документацией на GitHub (в основном там прописаны Docker файлы на запуск, но всегда есть конфиги)._

### Запускаем голый бинарь Prometheus, пишем юнит и простую автоматизацию

1. Изначально у вас должна быть установлена первичная `виртуалка А` в виде `Ubuntu 22.04` на английском языке:
   - После установки склонируйте её - это будет `виртуалка Б` и продолжайте работать на `виртуалке А`
   - В идеале сделать еще один клон с `виртуалкой С` и вообще его не трогать, чтобы она была, как резервная и `чистейшая ОС` на всякий случай
2. Взять директорию из корня за основную рабочую `/opt` (является частью стандартной файловой системы и предназначена для хранения дополнительного программного обеспечения):
   - Сделать себе в аккаунт **GitHub** [форк](https://github.com/lamjob1993/linux-monitoring/blob/main/%D0%A4%D0%BE%D1%80%D0%BA%20%D0%B2%20GitHub.md) репозитория [linux-monitoring](https://github.com/lamjob1993/linux-monitoring)
   - Далее склонировать ваш форкнутый репозиторий `linux-monitoring` в свою домашнюю директорию, к примеру в `/Downloads` или в `/Documents`:
      - Должна получиться домашняя клон-директория репозитория `/Documents/linux-monitoring/`:

                          /linux-monitoring      
                          ├── grafana             # Директория Grafana         
                          ├── node-exporter       # Директория Node Exporter
                          ├── prometheus          # Директория Prometheus
                          ├── e.t.c               # Остальные директории
        
3. Далее найти и скачать архив `.tar.gz` дистрибутива `Prometheus` для `Linux` самой последней второй (не третьей) версии в домашнюю директорию рядом со склонированным репозиторием `/Documents/linux-monitoring` (подсказка: GitHub, AMD64, bin)
4. Разархивировать архив и найти внутри директории бинарь `Prometheus` (директория после разархивации будет выглядеть, к примеру, вот так `/Documents/prometheus-2.53.2.linux-amd64`)
5. Проверить версию `Prometheus` (подсказка: `./prometheus --version` и запустить бинарь "на коленке" подсказка: `./bin/prometheus` или `./prometheus`)
6. Проверить запущенный на коленке `Prometheus` на веб-морде (подсказка: проверка должна быть в браузере на порту `:9090`, чтобы понять по какому ip адресу стучаться в `Prometheus`, нужно знать ip адрес интерфейса своей тачки (тачками называют машины и серверы - это синонимы))
7. Затем скопировать из домашней директории `/Documents/prometheus-2.53.2.linux-amd64` в домашнюю директорию `/Documents/linux-monitoring/prometheus` файлы:
 
                          /prometheus      
                          ├── prometheus.yml                    # ЭТОТ ФАЙЛ НУЖНО БУДЕТ СОЗДАТЬ САМОСТОЯТЕЛЬНО ПУСТЫМ / Основной конфигурационный файл Prometheus             
                          ├── prometheus                        # Бинарный файл Prometheus
                          ├── data                              # Директория, куда Prometheus пишет данные временных рядов
                          ├── consoles/                         # Директория для шаблонов консолей Prometheus
                          │   ├── index.html.example            # Пример главной страницы
                          │   ├── node-cpu.html                 # Шаблон консоли для мониторинга CPU узла
                          │   ├── node-disk.html                # Шаблон консоли для мониторинга диска узла
                          │   ├── node.html                     # Общий шаблон консоли для узла
                          │   ├── node-overview.html            # Обзорная консоль для узла
                          │   ├── prometheus.html               # Шаблон консоли для Prometheus
                          │   └── prometheus-overview.html      # Обзорная консоль для Prometheus
                          ├── console_libraries/                # Директория для библиотек шаблонов консолей
                          │   ├── menu.lib                      # Библиотека меню
                          │   └── prom.lib                      # Библиотека Prometheus
                          └── prometheus.service                # ЭТОТ ФАЙЛ НУЖНО БУДЕТ СОЗДАТЬ САМОСТОЯТЕЛЬНО ПУСТЫМ / Сервисный Unit-файл для запуска Prometheus

9. Где файл `unit_file` нужно написать с нуля (это файл отвечающий за запуск `Prometheus`)
10. Где файл `prometheus.yml` нужно написать с нуля (это основной конфиг-файл `Prometheus`). Подсказка, как этот файл написать: `GitHub` - `prometheus/documentation/examples/prometheus.yml`
11. Далее скопировать рекурсивно директорию `/linux-monitoring` в директорию `/opt`
12. Далее выдать рекурсивно права `777` на директорию `/linux-monitoring` входящую в состав `/opt` (`/opt` не трогаем, оставляем под `root`)
13. Обычно такие права `777` не выдаются (это `bad practicies`), либо выдаются в песочнице : то есть представьте себе, что вы инженер по разработке и работаете на платформе `DEV`, и всё же у нас учебный проект, поэтому имеем это ввиду:
    - Параллельно идем в `ИИ GPT Qwen` и учимся выставлять числовые права
    - Заодно учимся понимать, что такое `777` и как эти числа образуются `4+2+1`
15. Далее нужно создать группу пользователей `prometheus` и добавить туда пользователя `prometheus`:
    - Далее проверить эту группу пользователей, что `prometheus` добавился (одновременно идем в `ИИ GPT Qwen` и учимся назначать владельца на директорию и на файлы)
    - При дефолтной установке пакета `Prometheus`, будь то `.rpm` или `.deb` назначение прав и назначение владельца происходит автоматически
    - Здесь мы делаем назначение вручную, чтобы понимать логику работы команд: `chown` и `chmod` (то есть пользователь `prometheus` и его группа в целях безопасности должны обслуживать одно приложение **Прометеуса** и не иметь доступ ни к чему другому - в этом смысл)
16. Затем рекурсивно назначить владельца `prometheus` и группу `prometheus` для рабочей директории `/linux-monitoring` по адресу `/opt/linux-monitoring/prometheus`:
      
                        --права-- -владелец-  -группа-           /opt/linux-monitoring      
                       drwxrwxrwx prometheus prometheus          ├── grafana             # Директория Grafana         
                       drwxrwxrwx prometheus prometheus          ├── node-exporter       # Директория Node Exporter
                       drwxrwxrwx prometheus prometheus          ├── prometheus          # Директория Prometheus
                       drwxrwxrwx prometheus prometheus          ├── e.t.c               # Остальные директории
                  
19. Затем скопировать уже написанный вами `Unit` в директорию `/etc/systemd/system/` автозапуска `Linux` с уже выставленными правами `777` и владельцем `prometheus`
20. Чтобы система `Linux` поняла, что файл сервиса `Unit` добавлен в директорию `/systemd`, нужно вбить команду `sudo systemctl daemon-reload`:
    - Тем самым обновляя директорию `/systemd` до актуального состояния
    - Далее ставим наш сервис на автозапуск (то есть при ребуте системы сервис `Prometheus` будет взлетать автоматом) `sudo systemctl enable`
    - Читаем подробно в `ИИ Qwen` про эту команду и заодно еще раз про повторяем про пороцессы и демоны
21. Далее запускаем сервис `Prometheus` утилитой `systemctl` (в дефолте эта утилита смотрит в автозапуск `/systemd` и будет знать о том, что там лежит наш юнит):
    - Проверяем после запуска статус `ACTIVE` командой `sudo systemctl status prometheus.service` и смотрим на работающую веб-морду
    - А если `INACTIVE` или `FAIL`, то сразу читаем логи (смотрим следующий пункт темы)
    - Подсказка: смотрим в `Unit` либо смотрим в конфиг `YAML` в `Prometheus`, скорее всего ошиблись в одном из двух, часто бывают проблемы с выдачей прав и с неверными пользователями
22. Затем выводим логи `Prometheus` в терминал, которые отбрасывает запущенный `Prometheus` с помощью утилиты `journalctl`:
    - Параллельно для справки с помощью `Qwen` читаем, что такое: `stdin`, `stdout`, `stderr` 
23. Далее парсим (фильтруем) логи утилитой `grep` в файл `prometheus.log` (находясь в корневой директории `/prometheus`) по ключевому слову `info` (сохраняем логи "под ноги" `Prometheus`):
    - То есть конечный результат лога должен содержать только строки с `info`
    - Подсказка: `journalctl | grep` - используем перенаправление вывода из `journalctl` в `grep` с помощью пайпа `|`
    - А также подумайте, как с помощью `grep`:
       - Добавить новые записи в файл с сохранением в реальном времени (то есть не через однократное сохранение лога в файл) 
       - Грепать новые логи раз в минуту, записывая в файл:
          - Поставить мини-скрипт `grep` на `Bash` - `script_logs.sh` из под рабочей директории `/opt` в планировщик `crontab` на выполнение (подсказка: `0 * * * * /путь/к/script_logs.sh`, то есть `crontab` должен будет дёргать ваш мини-скрипт на выполнение раз в минуту):
             - Советую сначала потренироваться в запуске тестового скрипта
             - К примеру для начала разобраться какие права выдать скрипту, чтобы он запустился с тестовой фразой в терминале: `Hello, World!`
24. Далее перезагружаем `Ubuntu-виртуалку` и проверяем автозапуск через 2-3 минуты (`sudo systemctl status prometheus.service`), что юнит автоматически стартовал сервис `Prometheus` - он должен подняться на веб-морде
25. Далее копируем данные рабочего конфига `Prometheus` (исполняемые файлы не пушатся, только текстовые файлы, код и конфиги) в домашнюю директорию `/Documents/linux-monitoring/prometheus` и далее пушим данные в свой удаленный репозиторий (подсказка: сначала сделайте `git add .` потом `git commit -m "напишите какие файлы добавляете и что сделали"` и затем `git push`)
  - Пушить файлы из-под `/root` - это `bad practicies` и к тому же точно будут конфликты с правами на доступ (поэтому копируем все конфиги и скрипты сначала в домашнюю директорию, а потом пушим (при этом копируем уже в ранее склонированный репозиторий))
  - Не забываем про то, что вы написали еще и Bash скрипт, его нужно скопировать в домашнюю директорию и тоже запушить
27. Далее, так как мы подняли `Prometheus` и он работает — пробежимся по дебагу (просто представим, что приложению нужен дебаг, как будто это инцидент в банке и его нужно решать, а `Prometheus` у нас не работает):
    
    - С помощью утилиты `ss` найдите `prometheus` и посмотрите на каком порту он сидит, заодно посмотрите какой это порт: `TCP` или `UDP`
    - С помощью утилиты `telnet` проверьте доступность соединения `Prometheus` по дефолтному порту `Prometheus` (подумайте как это сделать)
    - С помощью утилиты — `curl` гетом (`GET`) скурлите (постучитесь `GET-запросом`) в `API Prometheus`, который должен вернуть `HTTP статус 2xx`, если сервису хорошо и `HTTP статус 5xx`, если плохо (заодно подтягиваем тему: методы и коды `HTTP`)
    - С помощью команды `ps` найдите `PID` процесса `Prometheus` (подсказка: `ps aux | grep ...`) и попробуйте убить его командой `kill` (сначала прочитайте, как убивать процессы, сначала во встроенном руководстве `man`, а потом в `Qwen`)
    - А также в дебаг входит `journactl` и `systemctl status`
    - Команды можно комбинировать между собой

28. В рабочую директорию `/opt/linux-monitoring/prometheus` положить второй `Bash` скрипт, который должен делать всю ручную работу выше автоматически:
    - Этот скрипт в финале должен поднять `Prometheus` с нуля за секунды и вы должны увидеть в терминале статус сервиса `ACTIVE`, а затем вы должны перейти в браузер и увидеть его на веб-морде:
       - То есть ставим всё что мы делали вручную выше на автоматизацию
    - Коммитим изменения и пушим в `GitHub` второй скрипт на установку `Prometheus` (не запускаем)
    - Далее нужно модернизировать этот скрипт на полное удаление `Prometheus` из системы, включая юнит, только осторожнее с директорией `/opt` - ее удалять не нужно
    - Коммитим изменения и пушим в `GitHub` третий скрипт на полное удаление (не запускаем)
      - Писать эти скрипты строго используя логические операторы `&&` (и) и `||` (или) - тем самым мы постепенно вникаем в тему логических операторов и учимся их комбинировать между собой:
         - То есть каждая строка скрипта должна выглядеть, как удаление директории `&&` вывод сообщения об успехе `||` вывод сообщения об ошибке:

                 rm -rf /tmp/example && echo "Директория успешно удалена" || { echo "Ошибка удаления директории"; exit 1; }

    - Далее протестировать эти два скрипта на текущей машине (с учетом того, что все ваши файлы уже запушены в `GitHub` из домашней директории и вы можете делать всё что угодно на этой машине, имеем только ввиду, что исполняемые файлы (бинарники) нельзя пушить в `GitHub`, поэтому эта тема написана таким образом, что пушить вы будете только текстовые файлы с кодом и с конфигурацией, как раз из директории локального репозитория)
29. Далее перейти в виртуальную машину `Ubuntu Б` из `п.1` и запустить её рядом с вашей машиной `Ubuntu А`
30. Прогнать из пункта выше готовый скрипт запуска `Prometheus` на голой машине Б:
    - Затем удалить `Prometheus` вторым скриптом (не забываем стопнуть `Prometheus` перед удалением, а после удаления сделать `daemon-reload`)
31. Подумать, как установить между этими двумя тачками `А` и `Б` соединение `SSH`, чтобы можно было ходить из одной машины в другую:
    - Подсказка: потренироваться генерить `SSH ключи` и понять, что такое публичный и закрытый ключи
    - Подсказка: после клона на `виртуалках А и Б` будут одинаковые `IP адреса`, нужно выключить обе виртуалки и прописать на каждой по 2 адаптера (один из сетевых адаптеров уже существует):
      - `Виртуалка А`: Сетевой адаптер + NAT адаптер
      - `Виртуалка Б`: Сетевой адаптер + NAT адаптер
32. Далее опишу, как у нас в банке проходила миграция. Я писал скрипт, который собирал `Prometheus` в архив из текущих файлов с тачки и перекидывал архив на соседний сервер
    - На этом этапе мы прогонять этот скрипт не будем, так как уже было написано достаточно скриптов для понимания их работы
33. Далее подумать, как с помощью утилиты `SCP` перекинуть изначально скачанный архив `Prometheus` с тачки `А` на тачку `Б` (проделать миграцию):
    - Нужно иметь ввиду, что перекидывать архив нужно в директорию `/tmp` (прочитайте за что она отвечает)
34. Далее скрипт на распаковку смигрированного архива и установку `Prometheus` мы писать не будем (действуем по аналогии с предыдущим пунктом), так как уже было написано достаточно скриптов для понимания их работы

## Выводы
В банке эта задача (здесь она слегка модернизирована) была моим первым кейсом на должности разработчика мониторинга. На задачу мне дали максимум 3 дня. На третий день уже была миграция. **Мой уровень был**: умею создавать файлы, переходить в директории, запускаю скрипты (не пишу), знаю как сохранить файл и выйти из Vim, знаю как выставлять права на файлы и распаковываю архивы.
