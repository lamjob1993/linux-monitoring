# Ansible
## Roles

В Ansible **`roles`** — это структурированные наборы файлов, которые группируют задачи, шаблоны, переменные и другие элементы для выполнения конкретной функции. Они предназначены для **модульности, повторного использования и упрощения управления** конфигурациями.

---

### **Почему нужны roles?**
- **Модульность**: Каждая роль отвечает за конкретную задачу (например, установка Nginx, настройка БД).
- **Повторное использование**: Роли можно переиспользовать в разных playbook'ах и проектах.
- **Чистота кода**: Упрощает чтение и поддержку кода за счёт разделения обязанностей.
- **Сообщество**: Готовые роли можно найти в [Ansible Galaxy](https://galaxy.ansible.com/).

---

### **Структура роли**
Роль состоит из папок и файлов, которые описывают её поведение. Обычная структура:

```plaintext
roles/
├── my_role
│   ├── tasks          # Основные задачи (обязательно)
│   │   └── main.yml
│   ├── handlers       # Обработчики событий (например, перезагрузка сервиса)
│   │   └── main.yml
│   ├── vars           # Переменные по умолчанию
│   │   └── main.yml
│   ├── defaults       # Переменные с настройками по умолчанию
│   │   └── main.yml
│   ├── templates      # Шаблоны для конфигурационных файлов (Jinja2)
│   │   └── config.j2
│   ├── files          # Статические файлы для копирования
│   │   └── example.txt
│   ├── libraries      # Пользовательские модули Python
│   ├── meta           # Зависимости ролей или информация о роли
│   │   └── main.yml
│   └── tests          # Тесты для роли
│       └── inventory
│       └── test.yml
└── another_role
    └── ...
```

---

### **Ключевые части роли**
1. **`tasks/main.yml`**  
   Здесь описываются задачи, которые выполняет роль. Например:
   ```yaml
   # tasks/main.yml
   - name: Установить Nginx
     apt:
       name: nginx
       state: present

   - name: Запустить Nginx
     service:
       name: nginx
       state: started
   ```

2. **`handlers/main.yml`**  
   Обработчики для событий (например, перезагрузка сервиса):
   ```yaml
   # handlers/main.yml
   - name: Перезагрузить Nginx
     service:
       name: nginx
       state: reloaded
   ```

3. **`defaults/main.yml`**  
   Переменные по умолчанию для роли:
   ```yaml
   # defaults/main.yml
   nginx_version: "1.21.3"
   nginx_config_dir: "/etc/nginx"
   ```

4. **`templates/`**  
   Шаблоны для конфигурационных файлов (например, `nginx.conf.j2`):
   ```jinja2
   # templates/nginx.conf.j2
   user {{ nginx_user }};
   worker_processes auto;
   error_log {{ nginx_log_path }} error;
   ```

5. **`vars/main.yml`**  
   Переменные, которые переопределяют значения из `defaults`:
   ```yaml
   # vars/main.yml
   nginx_user: "www-data"
   ```

---

### **Пример использования роли в playbook**
```yaml
# playbook.yml
- name: Установить и настроить Nginx
  hosts: webservers
  become: yes
  roles:
    - role: nginx
      vars:
        nginx_version: "1.22.0"  # Переопределяем переменную из defaults
```

---

### **Преимущества roles**
1. **Организация кода**: Все, что связано с задачей, находится в одной папке.
2. **Реусабельность**: Роль можно использовать в разных playbook'ах.
3. **Переменные**: Упрощает настройку ролей через `defaults`, `vars` и передачу параметров.
4. **Обработчики**: Избегает дублирования кода для повторяющихся действий (например, перезагрузка сервиса).

---

### **Где хранить роли?**
Стандартная структура проекта Ansible:
```plaintext
project/
├── inventory.ini
├── playbook.yml
└── roles/
    ├── node_exporter/
    ├── alertmanager/
    └── ...
```

---

### **Как создать роль?**
1. **Создать структуру**:
   ```bash
   ansible-galaxy init my_role
   ```

2. **Добавить задачи, шаблоны и переменные** в соответствующие папки.

3. **Использовать роль** в playbook'е через `roles: - my_role`.

---

### **Пример из предыдущего диалога**
В вашем проекте роль `node_exporter`:
```plaintext
roles/
├── node_exporter
│   ├── defaults
│   │   └── main.yml  # Переменные (версия, URL)
│   ├── tasks
│   │   └── main.yml  # Задачи (скачивание, установка, создание пользователя)
│   └── templates
│       └── node_exporter.service.j2  # Шаблон systemd
└── ...
```

---

### **Где найти готовые роли?**
- **Ansible Galaxy**: Marketplace с готовыми ролями (например, `community.general.nginx`).
- **GitHub**: Множество открытых ролей для популярных задач.

---

### **Итог**
Роли — это **основной инструмент** для организации сложных Ansible-проектов. Они позволяют:
- Разделить задачи на логические блоки.
- Упростить повторное использование кода.
- Улучшить читаемость и поддержку конфигураций.
