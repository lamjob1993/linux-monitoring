# Ansible
## Playbook

**Playbook** в Ansible — это основной инструмент для описания автоматизированных задач. Это YAML-файл, который содержит последовательность инструкций (задач), которые нужно выполнить на удалённых серверах. Playbook позволяет организовать сложные процессы, такие как установка ПО, настройка конфигураций, развертывание приложений и т.д.

---

### **Основные элементы Playbook**
1. **`hosts`**  
   Указывает, на какие хосты/группы хостов будут применяться задачи.
   ```yaml
   hosts: webservers
   ```

2. **`tasks`**  
   Список задач, которые нужно выполнить. Каждая задача связана с модулем Ansible (например, `apt`, `file`, `template`).
   ```yaml
   tasks:
     - name: Установить Nginx
       apt:
         name: nginx
         state: present
   ```

3. **`vars`**  
   Переменные, которые используются в playbook.
   ```yaml
   vars:
     app_name: myapp
     app_port: 8080
   ```

4. **`roles`**  
   Ссылки на роли (структурированные наборы задач), которые нужно применить.
   ```yaml
   roles:
     - common
     - webserver
   ```

5. **`handlers`**  
   Обработчики событий (например, перезапуск сервиса после изменений).
   ```yaml
   handlers:
     - name: Перезапустить Nginx
       service:
         name: nginx
         state: restarted
   ```

---

### **Пример простого Playbook**
```yaml
---
- name: Установить и настроить Nginx
  hosts: webservers
  become: yes  # Использовать права sudo

  vars:
    nginx_config: "/etc/nginx/nginx.conf"

  tasks:
    - name: Установить Nginx
      apt:
        name: nginx
        state: present

    - name: Загрузить конфигурационный файл
      template:
        src: templates/nginx.conf.j2
        dest: "{{ nginx_config }}"
      notify: Перезапустить Nginx

    - name: Запустить Nginx
      service:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: Перезапустить Nginx
      service:
        name: nginx
        state: restarted
```

---

### **Как использовать Playbook**
#### 1. **Создание Playbook**
   - Создайте файл с расширением `.yml` или `.yaml`, например `deploy.yml`.
   - Определите структуру, как в примере выше.

#### 2. **Настройка инвентори (inventory)**
   - Создайте файл `inventory.ini` с перечислением хостов:
     ```ini
     [webservers]
     server1 ansible_host=192.168.1.10
     server2 ansible_host=192.168.1.11
     ```

#### 3. **Запуск Playbook**
   - Используйте команду:
     ```bash
     ansible-playbook -i inventory.ini deploy.yml
     ```
   - Опции:
     - `-v` — выводить подробную информацию.
     - `--limit` — ограничить выполнение определённой группе хостов.
     - `--check` — эмуляция выполнения (без изменений).

#### 4. **Использование ролей**
   - В playbook можно включать роли:
     ```yaml
     roles:
       - role: common
         vars:
           some_variable: "value"
     ```

#### 5. **Переменные**
   - Переменные можно задавать:
     - Внутри playbook (`vars`).
     - В отдельных файлах (`vars/main.yml` в роли).
     - Через командную строку:
       ```bash
       ansible-playbook -e "nginx_port=8080" deploy.yml
       ```

---

### **Структура проекта**
Обычно проект организуется так:
```plaintext
project/
├── inventory.ini       # Список хостов
├── deploy.yml          # Основной playbook
└── roles/              # Папка с ролями
    ├── common/
    │   ├── tasks/
    │   └── templates/
    └── webserver/
        ├── tasks/
        └── handlers/
```

---

### **Преимущества Playbook**
1. **Идемпотентность**  
   Можно запускать playbook несколько раз — он не выполнит повторные изменения, если всё уже настроено.

2. **Модульность**  
   С помощью ролей можно повторно использовать код между проектами.

3. **Читаемость**  
   YAML-синтаксис делает playbook понятными для чтения.

4. **Автоматизация**  
   Можно интегрировать playbook в CI/CD-пайплайны (Jenkins, GitHub Actions).

---

### **Основные шаги в работе с Playbook**
1. **Определение задач**: Что нужно сделать (установка ПО, настройка файлов).
2. **Структурирование**: Разделение на роли и задачи.
3. **Тестирование**: Запуск на тестовых хостах.
4. **Использование**: Запуск на production-серверах.
5. **Обновление**: Добавление новых задач или изменение существующих.

---

### **Примеры задач в Playbook**
1. **Установка ПО**:
   ```yaml
   - name: Установить Python
     apt:
       name: python3
       state: present
   ```

2. **Создание файла**:
   ```yaml
   - name: Создать конфигурационный файл
     copy:
       src: files/config.txt
       dest: /etc/myapp/config.txt
   ```

3. **Использование шаблонов**:
   ```yaml
   - name: Создать настраиваемый конфиг
     template:
       src: templates/app.conf.j2
       dest: /etc/app.conf
   ```

4. **Управление сервисами**:
   ```yaml
   - name: Перезапустить сервис
     service:
       name: myservice
       state: restarted
   ```

---

### **Советы по написанию Playbook**
- Используйте **переменные** для настраиваемых значений.
- Разделяйте задачи на **роли** для повторного использования.
- Добавляйте **комментарии** для понимания кода.
- Используйте **инвентори** для группировки хостов.
- Тестируйте изменения на тестовых серверах.

---

### **Где найти готовые Playbook?**
- **Ansible Galaxy**: Marketplace с готовыми ролями и playbook'ами.
- **GitHub**: Множество открытых проектов с примерами.
- **Документация**: Официальные примеры в [Ansible Docs](https://docs.ansible.com/ansible/latest/index.html).

---

### **Итог**
Playbook — это "рецепт" для автоматизации задач в Ansible. Он позволяет:
- Описать последовательность действий.
- Управлять удалёнными серверами.
- Использовать модули, роли и переменные.
- Стандартизировать процессы развертывания и настройки.
