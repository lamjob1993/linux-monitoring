## Prometheus федерация

Это механизм, который позволяет объединить несколько экземпляров Prometheus для масштабирования и разделения мониторинга на подсистемы или географические регионы. Это полезно, когда один экземпляр Prometheus не может обрабатывать весь объем метрик из-за ограничений производительности или необходимости изоляции данных.

### Практический пример создания Prometheus федерации

#### 1. **Цель**
Предположим, что у нас есть инфраструктура, развернутая в трех разных дата-центрах: `DC1`, `DC2` и `DC3`. Мы хотим мониторить каждый дата-центр отдельно с помощью локальных экземпляров Prometheus (`prometheus-dc1`, `prometheus-dc2`, `prometheus-dc3`) и иметь центральный экземпляр Prometheus (`prometheus-central`), который будет агрегировать ключевые метрики со всех дата-центров.

#### 2. **Архитектура**
- **Локальные Prometheus** (`prometheus-dc1`, `prometheus-dc2`, `prometheus-dc3`):
  - Собирают все метрики из своего дата-центра.
  - Экспонируют определенные метрики для центрального Prometheus через федерацию.
  
- **Центральный Prometheus** (`prometheus-central`):
  - Использует федерацию для сбора ключевых метрик с локальных Prometheus.
  - Предоставляет общий обзор всей инфраструктуры.

#### 3. **Настройка локальных Prometheus**

Каждый локальный Prometheus должен быть настроен так, чтобы он экспортировал определенные метрики для федерации. Это делается с помощью параметра `--web.enable-admin-api` и конфигурации правил выборки метрик.

Пример конфигурации для `prometheus-dc1`:

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'federation'
    honor_labels: true
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job="node-exporter"}'  # Выбираем метрики только от node-exporter
        - '{__name__=~"up|process_cpu_usage"}'  # Дополнительные метрики
    static_configs:
      - targets:
          - 'localhost:9090'  # Адрес самого себя для федерации
```

Запускаем `prometheus-dc1` с флагом `--web.enable-admin-api`.

#### 4. **Настройка центрального Prometheus**

Центральный Prometheus должен быть настроен для сбора метрик с локальных экземпляров через федерацию.

Пример конфигурации для `prometheus-central`:

```yaml
global:
  scrape_interval: 30s

scrape_configs:
  - job_name: 'federation-dc1'
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job="node-exporter"}'
        - '{__name__=~"up|process_cpu_usage"}'
    static_configs:
      - targets:
          - 'dc1-prometheus:9090'  # Адрес prometheus-dc1

  - job_name: 'federation-dc2'
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job="node-exporter"}'
        - '{__name__=~"up|process_cpu_usage"}'
    static_configs:
      - targets:
          - 'dc2-prometheus:9090'  # Адрес prometheus-dc2

  - job_name: 'federation-dc3'
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job="node-exporter"}'
        - '{__name__=~"up|process_cpu_usage"}'
    static_configs:
      - targets:
          - 'dc3-prometheus:9090'  # Адрес prometheus-dc3
```

#### 5. **Требования к хостам**

- Для каждого локального Prometheus (`prometheus-dc1`, `prometheus-dc2`, `prometheus-dc3`) потребуется отдельный хост или контейнер.
- Для центрального Prometheus (`prometheus-central`) также потребуется отдельный хост или контейнер.

Таким образом, минимальное количество хостов/машин для этой конфигурации — **4** (по одному для каждого локального Prometheus и один для центрального).

#### 6. **Дополнительные соображения**

- **Масштабируемость**: Если количество метрик или дата-центров увеличивается, можно добавить больше локальных Prometheus и соответствующих целей в центральном Prometheus.
- **Репликация данных**: Чтобы обеспечить высокую доступность, можно запустить несколько реплик каждого локального Prometheus и использовать их как источники данных для центрального Prometheus.
- **Горизонтальное масштабирование**: В случае очень большого количества метрик, можно разделить мониторинг внутри одного дата-центра на несколько Prometheus экземпляров и использовать федерацию для объединения данных.

### Заключение

В данном примере мы рассмотрели, как настроить федерацию Prometheus для мониторинга нескольких дата-центров. Минимальное количество хостов для такой конфигурации — **3**, но при необходимости можно масштабировать систему, добавляя дополнительные экземпляры Prometheus.

---

## params: 'match[]'

В конфигурации Prometheus параметр `params` используется для передачи дополнительных параметров в запросы HTTP, которые Prometheus отправляет при сборе метрик. В данном случае, параметр `match[]` — это специальный параметр, который используется в федерации Prometheus для выбора определенных метрик из удаленного экземпляра Prometheus.

### Разберем построчно:

```yaml
params:
  'match[]':
    - '{job="node-exporter"}'
    - '{__name__=~"up|process_cpu_usage"}'
```

#### 1. **`params`**
Это секция в конфигурации, где вы можете указать дополнительные параметры для HTTP-запросов, которые Prometheus будет отправлять на целевой endpoint. В случае федерации, мы используем этот параметр для фильтрации метрик, которые нужно собрать с удаленного Prometheus.

#### 2. **`match[]`**
`match[]` — это специальный параметр, который позволяет выбрать подмножество метрик из удаленного экземпляра Prometheus. Он принимает список строк, каждая из которых представляет собой PromQL-подобное выражение для фильтрации метрик.

#### 3. **`'{job="node-exporter"}'`**
Это одно из выражений для фильтрации метрик. Оно говорит Prometheus выбирать только те метрики, у которых лейбл `job` равен `"node-exporter"`. Это может быть полезно, если вы хотите агрегировать только метрики, связанные с мониторингом хостов (например, CPU, память, диск и т.д.), которые собираются через `node-exporter`.

#### 4. **`'{__name__=~"up|process_cpu_usage"}'`**
Это второе выражение для фильтрации метрик. Здесь используется регулярное выражение (`=~`) для выбора метрик по их имени (`__name__`). Конкретно это выражение выбирает метрики с именами `up` или `process_cpu_usage`.

- `up`: Это метрика, которая показывает статус доступности целевого сервиса (1 — доступен, 0 — недоступен).
- `process_cpu_usage`: Это метрика, которая показывает использование CPU процессом.

Таким образом, это выражение позволяет выбрать только эти две метрики из всех доступных в удаленном Prometheus.

---

### Что происходит в целом?

Когда центральный Prometheus делает запрос к локальному Prometheus через `/federate` endpoint, он добавляет параметры `match[]` в URL-адрес запроса. Например, запрос может выглядеть так:

```
GET /federate?match[]={job="node-exporter"}&match[]={__name__=~"up|process_cpu_usage"}
```

Локальный Prometheus обрабатывает этот запрос, фильтрует метрики согласно указанным условиям и возвращает только те метрики, которые соответствуют этим правилам.

---

### Почему это полезно?

Использование `match[]` позволяет центральному Prometheus собирать только необходимые метрики, а не все данные, что помогает снизить нагрузку на центральный экземпляр Prometheus и сэкономить ресурсы (память, диск и т.д.). Это особенно важно в больших системах, где объем метрик может быть очень большим.

---

### Пример без фильтрации

Если бы мы не использовали `match[]`, то центральный Prometheus собрал бы **все** метрики с удаленного экземпляра Prometheus. Это может привести к чрезмерной нагрузке на центральный Prometheus и усложнить анализ данных.

Например, без фильтрации запрос мог бы выглядеть так:

```
GET /federate
```

В этом случае Prometheus вернет все метрики, которые есть в удаленном экземпляре.

---

### Итог

Параметр `match[]` в секции `params` позволяет фильтровать метрики при федерации Prometheus. Он используется для выбора конкретных метрик, которые нужно агрегировать в центральном Prometheus, основываясь на их лейблах или именах. Это помогает оптимизировать работу системы мониторинга и снизить нагрузку на центральный экземпляр.
